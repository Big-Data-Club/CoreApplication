name: CD â€” Deploy Production

on:
  workflow_run:
    workflows: ["CI - Build, Test & Push"]
    types: [completed]
    branches: [main]

  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag cáº§n deploy'
        required: false
        default: 'latest'
      force_restart:
        description: 'Force down toÃ n bá»™ stack trÆ°á»›c khi deploy'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  APP_DIR: /home/bdc_web/codespace/bdc_deploy

jobs:
  gate:
    name: ðŸ” Kiá»ƒm tra Ä‘iá»u kiá»‡n
    runs-on: ubuntu-latest
    outputs:
      ok:  ${{ steps.check.outputs.ok }}
      tag: ${{ steps.check.outputs.tag }}

    steps:
      - name: Evaluate
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ok=true"  >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger"
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "ok=true"  >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "âœ… CI passed"
          else
            echo "ok=false" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "â­ï¸ CI khÃ´ng pass (${{ github.event.workflow_run.conclusion }}) â€” skip"
          fi

  deploy:
    name: ðŸš€ Deploy Production
    runs-on: [self-hosted, linux, production, deploy]
    needs: gate
    if: needs.gate.outputs.ok == 'true'

    environment:
      name: production
      url: https://bdc.hpcc.vn

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          clean: true

      - name: Cáº­p nháº­t IMAGE_TAG
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          IMAGE_TAG: ${{ needs.gate.outputs.tag }}
        run: |
          ENV_FILE="${{ env.APP_DIR }}/.env"
          [[ -f "$ENV_FILE" ]] || { echo "âŒ .env khÃ´ng tá»“n táº¡i táº¡i $ENV_FILE"; exit 1; }
          sed -i "s|^IMAGE_TAG=.*|IMAGE_TAG=${IMAGE_TAG}|"                   "$ENV_FILE"
          sed -i "s|^DOCKER_USERNAME=.*|DOCKER_USERNAME=${DOCKER_USERNAME}|" "$ENV_FILE"
          echo "ðŸ“Œ IMAGE_TAG=${IMAGE_TAG}, DOCKER_USERNAME=${DOCKER_USERNAME}"

      - name: Force stop stack
        if: ${{ github.event.inputs.force_restart == 'true' }}
        run: |
          cd ${{ env.APP_DIR }}
          echo "ðŸ”´ Force restart â€” dá»«ng toÃ n bá»™ stack..."
          docker compose down --remove-orphans --timeout 30
          echo "âœ… ÄÃ£ dá»«ng"

      - name: Deploy
        run: bash ${{ env.APP_DIR }}/deploy.sh

      - name: Health check
        run: |
          echo "â³ Chá» services á»•n Ä‘á»‹nh (15s)..."
          sleep 15

          FAILED=0
          _check() {
            if curl -sf --max-time 10 "$1" > /dev/null 2>&1; then
              echo "âœ… $2"
            else
              echo "âŒ $2 ($1)"
              FAILED=1
            fi
          }

          _check "http://localhost:3000/api/health"      "Frontend"
          _check "http://localhost:8080/actuator/health" "Backend"
          _check "http://localhost:8081/health"          "LMS"

          if [[ $FAILED -eq 1 ]]; then
            echo ""
            echo "Container status:"
            docker compose -f ${{ env.APP_DIR }}/docker-compose.yml ps
            exit 1
          fi
          echo "âœ… Táº¥t cáº£ healthy!"

      - name: Docker logout
        if: always()
        run: docker logout || true

      - name: Summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          [[ "$STATUS" == "success" ]] && ICON="âœ…" || ICON="âŒ"
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ${ICON} Deploy ${STATUS}
          | | |
          |---|---|
          | **URL** | https://bdc.hpcc.vn |
          | **Tag** | \`${{ needs.gate.outputs.tag }}\` |
          | **Commit** | \`${{ github.sha }}\` |
          | **Time** | $(date '+%Y-%m-%d %H:%M:%S %Z') |

          \`\`\`
          $(docker compose -f ${{ env.APP_DIR }}/docker-compose.yml ps 2>&1 || true)
          \`\`\`
          EOF