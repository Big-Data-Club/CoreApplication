name: CD - Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      - 'Backend/**'
      - 'frontend/**'
      - 'LMS/**'
      - 'docker-compose.yml'
      - '.github/workflows/cd-production.yml'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (all/frontend/backend/lms)'
        required: false
        type: choice
        options:
          - all
          - frontend
          - backend
          - lms
        default: 'all'

env:
  DEPLOY_PATH: /home/bdc_web/bdc
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  # STAGE 1: Detect Changes
  detect-changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      lms: ${{ steps.filter.outputs.lms }}
      deploy_backend: ${{ steps.should_deploy.outputs.backend }}
      deploy_frontend: ${{ steps.should_deploy.outputs.frontend }}
      deploy_lms: ${{ steps.should_deploy.outputs.lms }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'Backend/**'
            frontend:
              - 'frontend/**'
            lms:
              - 'LMS/**'

      - name: Determine what to deploy
        id: should_deploy
        run: |
          MANUAL_SERVICE="${{ github.event.inputs.service }}"
          
          # If manual trigger with specific service
          if [ -n "$MANUAL_SERVICE" ] && [ "$MANUAL_SERVICE" != "all" ]; then
            echo "backend=$( [ '$MANUAL_SERVICE' = 'backend' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
            echo "frontend=$( [ '$MANUAL_SERVICE' = 'frontend' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
            echo "lms=$( [ '$MANUAL_SERVICE' = 'lms' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          # If manual trigger with "all" or auto trigger
          else
            # Auto-detect or deploy all
            if [ "$MANUAL_SERVICE" = "all" ]; then
              echo "backend=true" >> $GITHUB_OUTPUT
              echo "frontend=true" >> $GITHUB_OUTPUT
              echo "lms=true" >> $GITHUB_OUTPUT
            else
              # Deploy based on file changes
              echo "backend=${{ steps.filter.outputs.backend }}" >> $GITHUB_OUTPUT
              echo "frontend=${{ steps.filter.outputs.frontend }}" >> $GITHUB_OUTPUT
              echo "lms=${{ steps.filter.outputs.lms }}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate version
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "version=main-${SHORT_SHA}" >> $GITHUB_OUTPUT

  # STAGE 2: Deploy Services (Self-Hosted Runner)
  deploy-production:
    name: üöÄ Deploy to Production
    runs-on: self-hosted
    needs: detect-changes
    environment:
      name: production
      url: https://bdc.hpcc.vn
    
    steps:
      - name: Deployment notification
        run: |
          echo "üöÄ Starting production deployment..."
          echo "üìå Version: ${{ needs.detect-changes.outputs.version }}"
          echo "üìñ Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
          echo "üè† Runner: $(hostname)"
          echo ""
          echo "Services to deploy:"
          echo "  - Backend: ${{ needs.detect-changes.outputs.deploy_backend }}"
          echo "  - Frontend: ${{ needs.detect-changes.outputs.deploy_frontend }}"
          echo "  - LMS: ${{ needs.detect-changes.outputs.deploy_lms }}"

      - name: Check deployment directory
        run: |
          if [ ! -d "${{ env.DEPLOY_PATH }}" ]; then
            echo "‚ùå Deployment directory not found: ${{ env.DEPLOY_PATH }}"
            exit 1
          fi
          cd ${{ env.DEPLOY_PATH }}
          echo "‚úÖ Deployment directory exists"
          ls -la

      # Backup current state
      - name: Create backup
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "üíæ Creating backup before deployment..."
          ./manage.sh backup || echo "‚ö†Ô∏è Backup script not found or failed"

      # Pull latest Docker images
      - name: Pull latest images
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "üì• Pulling latest Docker images..."
          
          # Load environment variables
          source .env
          
          # Pull images based on what changed
          if [ "${{ needs.detect-changes.outputs.deploy_backend }}" == "true" ]; then
            echo "Pulling backend image..."
            docker pull ${DOCKER_USERNAME}/bdc-backend:latest
          fi
          
          if [ "${{ needs.detect-changes.outputs.deploy_frontend }}" == "true" ]; then
            echo "Pulling frontend image..."
            docker pull ${DOCKER_USERNAME}/bdc-frontend:latest
          fi
          
          if [ "${{ needs.detect-changes.outputs.deploy_lms }}" == "true" ]; then
            echo "Pulling LMS image..."
            docker pull ${DOCKER_USERNAME}/bdc-lms:latest
          fi
          
          echo "‚úÖ Images pulled successfully"

      # Deploy Backend
      - name: Deploy Backend
        if: needs.detect-changes.outputs.deploy_backend == 'true'
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "üîÑ Deploying backend service..."
          
          # Recreate only backend container
          docker compose up -d --no-deps --force-recreate backend
          
          echo "‚è≥ Waiting for backend to be healthy..."
          sleep 10
          
          # Wait for backend health check
          for i in {1..24}; do
            if docker compose ps | grep "backend" | grep -q "healthy"; then
              echo "‚úÖ Backend is healthy!"
              break
            fi
            if [ $i -eq 24 ]; then
              echo "‚ùå Timeout waiting for backend health"
              docker compose logs backend --tail=50
              exit 1
            fi
            echo "‚è≥ Waiting... ($i/24)"
            sleep 5
          done

      # Deploy LMS
      - name: Deploy LMS
        if: needs.detect-changes.outputs.deploy_lms == 'true'
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "üîÑ Deploying LMS service..."
          
          # Recreate only LMS container
          docker compose up -d --no-deps --force-recreate lms-backend
          
          echo "‚è≥ Waiting for LMS to be healthy..."
          sleep 10
          
          # Wait for LMS health check
          for i in {1..24}; do
            if docker compose ps | grep "lms-backend" | grep -q "healthy"; then
              echo "‚úÖ LMS is healthy!"
              break
            fi
            if [ $i -eq 24 ]; then
              echo "‚ùå Timeout waiting for LMS health"
              docker compose logs lms-backend --tail=50
              exit 1
            fi
            echo "‚è≥ Waiting... ($i/24)"
            sleep 5
          done

      # Deploy Frontend
      - name: Deploy Frontend
        if: needs.detect-changes.outputs.deploy_frontend == 'true'
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "üîÑ Deploying frontend service..."
          
          # Recreate only frontend container
          docker compose up -d --no-deps --force-recreate frontend
          
          echo "‚è≥ Waiting for frontend to be healthy..."
          sleep 10
          
          # Wait for frontend health check
          for i in {1..24}; do
            if docker compose ps | grep "frontend" | grep -q "healthy"; then
              echo "‚úÖ Frontend is healthy!"
              break
            fi
            if [ $i -eq 24 ]; then
              echo "‚ùå Timeout waiting for frontend health"
              docker compose logs frontend --tail=50
              exit 1
            fi
            echo "‚è≥ Waiting... ($i/24)"
            sleep 5
          done

      # Post-deployment checks
      - name: Show deployment status
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "üìä Deployment Status:"
          echo "===================="
          docker compose ps
          echo ""
          
          echo "üìä Container Stats:"
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"
          echo ""
          
          echo "üíæ Disk Usage:"
          df -h / | grep -v tmpfs

      - name: Clean up old Docker resources
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "üßπ Cleaning up old Docker resources..."
          
          # Remove old images (keep last 24h)
          docker image prune -f --filter "until=24h" || true
          
          # Remove unused volumes (be careful!)
          # docker volume prune -f || true
          
          echo "‚úÖ Cleanup completed"

      - name: Deployment complete
        run: |
          echo "‚úÖ Production Deployment Successful!"
          echo "===================================="
          echo "üïê Time: $(date)"
          echo "üìñ Commit: ${{ github.sha }}"
          echo "üìå Version: ${{ needs.detect-changes.outputs.version }}"
          echo "üåê URL: https://bdc.hpcc.vn"
          echo "üè† Server: $(hostname)"
          echo ""
          echo "Deployed services:"
          echo "  - Backend: ${{ needs.detect-changes.outputs.deploy_backend }}"
          echo "  - Frontend: ${{ needs.detect-changes.outputs.deploy_frontend }}"
          echo "  - LMS: ${{ needs.detect-changes.outputs.deploy_lms }}"

  # STAGE 3: Health Checks & Notifications
  verify-deployment:
    name: ‚úÖ Verify Deployment
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-production]
    if: always() && needs.deploy-production.result == 'success'
    
    steps:
      - name: Wait for services to stabilize
        run: |
          echo "‚è≥ Waiting for services to stabilize..."
          sleep 15

      - name: Health check - Frontend
        if: needs.detect-changes.outputs.deploy_frontend == 'true'
        run: |
          echo "üè• Checking Frontend health..."
          for i in {1..5}; do
            if curl -f -s https://bdc.hpcc.vn/api/health > /dev/null; then
              echo "‚úÖ Frontend is healthy!"
              exit 0
            fi
            echo "‚è≥ Attempt $i/5 failed, retrying in 10s..."
            sleep 10
          done
          echo "‚ùå Frontend health check failed"
          exit 1

      - name: Health check - Backend
        if: needs.detect-changes.outputs.deploy_backend == 'true'
        run: |
          echo "üè• Checking Backend health..."
          for i in {1..5}; do
            if curl -f -s https://bdc.hpcc.vn/apiv1/actuator/health > /dev/null; then
              echo "‚úÖ Backend is healthy!"
              HEALTH=$(curl -s https://bdc.hpcc.vn/apiv1/actuator/health)
              echo "$HEALTH" | jq . || echo "$HEALTH"
              exit 0
            fi
            echo "‚è≥ Attempt $i/5 failed, retrying in 10s..."
            sleep 10
          done
          echo "‚ùå Backend health check failed"
          exit 1

      - name: Health check - LMS
        if: needs.detect-changes.outputs.deploy_lms == 'true'
        run: |
          echo "üè• Checking LMS health..."
          for i in {1..5}; do
            if curl -f -s https://bdc.hpcc.vn/lmsapiv1/health > /dev/null; then
              echo "‚úÖ LMS is healthy!"
              exit 0
            fi
            echo "‚è≥ Attempt $i/5 failed, retrying in 10s..."
            sleep 10
          done
          echo "‚ùå LMS health check failed"
          exit 1

      - name: Generate deployment report
        run: |
          echo "## üöÄ Production Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Successful" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.detect-changes.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Health Check |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.detect-changes.outputs.deploy_frontend == 'true' && '‚úÖ Deployed' || '‚è≠Ô∏è Skipped' }} | ‚úÖ Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.detect-changes.outputs.deploy_backend == 'true' && '‚úÖ Deployed' || '‚è≠Ô∏è Skipped' }} | ‚úÖ Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "| LMS | ${{ needs.detect-changes.outputs.deploy_lms == 'true' && '‚úÖ Deployed' || '‚è≠Ô∏è Skipped' }} | ‚úÖ Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üåê Live URL:** https://bdc.hpcc.vn" >> $GITHUB_STEP_SUMMARY

  # STAGE 4: Rollback on Failure
  rollback-on-failure:
    name: üîÑ Rollback
    runs-on: self-hosted
    needs: [detect-changes, deploy-production, verify-deployment]
    if: failure() && needs.deploy-production.result == 'success'
    
    steps:
      - name: Rollback notification
        run: |
          echo "‚ö†Ô∏è Deployment verification failed - initiating rollback..."
          echo "üìñ Commit: ${{ github.sha }}"

      - name: Restore from backup
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "üîÑ Rolling back to previous version..."
          
          # Find latest backup
          LATEST_BACKUP=$(ls -t backups/ | head -1)
          
          if [ -z "$LATEST_BACKUP" ]; then
            echo "‚ùå No backup found for rollback"
            exit 1
          fi
          
          echo "üì¶ Rolling back using backup: $LATEST_BACKUP"
          
          # Restore databases if needed
          # docker compose exec -T postgres psql -U postgres club_db < "backups/$LATEST_BACKUP/auth_db.sql"
          
          # Restart services with previous images
          docker compose restart
          
          echo "‚úÖ Rollback completed"

      - name: Verify rollback
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "‚è≥ Verifying rollback..."
          sleep 10
          docker compose ps

  # ============================================================================
  # STAGE 5: Notifications
  # ============================================================================
  notify:
    name: üì¨ Send Notifications
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-production, verify-deployment]
    if: always()
    
    steps:
      - name: Deployment status summary
        run: |
          if [ "${{ needs.verify-deployment.result }}" == "success" ]; then
            echo "‚úÖ Production deployment successful!"
            echo ""
            echo "Deployed services:"
            echo "  - Frontend: ${{ needs.detect-changes.outputs.deploy_frontend }}"
            echo "  - Backend: ${{ needs.detect-changes.outputs.deploy_backend }}"
            echo "  - LMS: ${{ needs.detect-changes.outputs.deploy_lms }}"
            echo ""
            echo "üåê Live at: https://bdc.hpcc.vn"
          else
            echo "‚ùå Production deployment failed!"
            echo "üìã Check the deployment logs for details"
          fi

      # Add your notification integrations here:
      # - Slack webhook
      # - Discord webhook
      # - Email notification
      # - MS Teams webhook
      # etc.
      
      # Example Slack notification:
      # - name: Notify Slack
      #   if: always()
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     payload: |
      #       {
      #         "text": "Deployment ${{ needs.verify-deployment.result }}"
      #       }